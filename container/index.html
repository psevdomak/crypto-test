<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>CryptoPro container test</title>

        <script src="https://cryptopro.ru/sites/default/files/products/cades/cadesplugin_api.js"></script>
    </head>
    <body>
        <button id="show-containers-btn">Показать контейнеры</button>

        <div id="containers-info" style="margin-top: 20px;"></div>

        <div id="error" style="color: red; margin-top: 20px"></div>
        <div id="success" style="color: green; margin-top: 20px"></div>

        <script>
            const errorDiv = document.querySelector('#error');
            const successDiv = document.querySelector('#success');

            // Добавляем обработчик для кнопки показа контейнеров
            const showContainersButton = document.querySelector('#show-containers-btn');
            showContainersButton.addEventListener('click', () => {
                errorDiv.innerHTML = '';
                successDiv.innerHTML = '';
                const containersInfoDiv = document.querySelector('#containers-info');
                containersInfoDiv.innerHTML = '';
                
                showContainersInfo();
            });

            function showContainersInfo() {
                cadesplugin.async_spawn(function* () {
                    try {
                        // Создаем объект для работы с информацией о CSP
                        const OAbout = yield cadesplugin.CreateObjectAsync('CAdESCOM.About');
                        const CSPName = yield OAbout.CSPName(80);
                        const cspInfo = yield cadesplugin.CreateObjectAsync("X509Enrollment.CCspInformation");
                        
                        yield cspInfo.InitializeFromName(CSPName);

                        
                        // Получаем список контейнеров
                        const containers = yield cspInfo.EnumContainers();
                        
                        // Получаем количество контейнеров
                        const count = yield containers.Count;
                        
                        let containersHtml = "<h3>Контейнеры (" + count + ")</h3>";
                        
                        if (count > 0) {
                            containersHtml += "<ul>";
                            
                            // Проходим по всем контейнерам
                            for (let i = 0; i < count; i++) {
                                const container = yield containers.ItemByIndex(i);

                                console.log(container);

                                // Получаем имя контейнера
                                const name = yield container.Name;
                                
                                console.log(name);

                                containersHtml += '<li style="margin-bottom: 12px;">';
                                containersHtml += '<strong>Имя контейнера:</strong> ' + name + '<br>';
                                containersHtml += '<button onclick="deleteContainer(\'' + name + '\')">Удалить</button>';
                                containersHtml += '</li>';
                            }
                            
                            containersHtml += "</ul>";
                        } else {
                            containersHtml += "<p>Контейнеры не найдены</p>";
                        }
                        
                        const containersInfoDiv = document.querySelector('#containers-info');
                        containersInfoDiv.innerHTML = containersHtml;
                    } catch (error) {
                        console.log(error);
                        errorDiv.innerHTML = "Ошибка при получении списка контейнеров: " + error.message;
                    }
                });
            }
            
            // Функция для удаления контейнера
            function deleteContainer(containerName) {
                cadesplugin.async_spawn(function* () {
                    try {
                        // Создаем объект для работы с информацией о CSP
                        const OAbout = yield cadesplugin.CreateObjectAsync('CAdESCOM.About');
                        const CSPName = yield OAbout.CSPName(80);
                        const cspInfo = yield cadesplugin.CreateObjectAsync("X509Enrollment.CCspInformation");
                        yield cspInfo.InitializeFromName(CSPName);
                        
                        // Получаем список контейнеров
                        const containers = yield cspInfo.EnumContainers();
                        
                        // Получаем количество контейнеров
                        const count = yield containers.Count;
                        
                        // Ищем контейнер по имени
                        let foundContainer = null;
                        for (let i = 0; i < count; i++) {
                            const container = yield containers.ItemByIndex(i);
                            const name = yield container.Name;
                            
                            if (name === containerName) {
                                foundContainer = container;
                                break;
                            }
                        }
                        
                        if (foundContainer) {
                            // Удаляем контейнер
                            yield foundContainer.Delete();
                            
                            successDiv.innerHTML = "Контейнер успешно удален";
                            
                            // Обновляем список контейнеров
                            showContainersInfo();
                        }
                    } catch (error) {
                        console.log(error);
                        errorDiv.innerHTML = "Ошибка при удалении контейнера: " + error.message;
                    }
                });
            }
        </script>
    </body>
</html>
